define(["sensor/util","sensor/wave"],function(e,t){var s=function(t,s){var t=e.getElement(t);return t?(this.maskedDom=t,this._configs={left:0,top:0,color:"#666",alpha:100,checkDistance:20,radius:20,alphaRadius:10,smooth:!0,showPoint:!1},void(e.isFunction(s)?this.setCallback(s):e.extend(this._configs,s||{},!0))):void alert("必须要配置使用遮罩的DOM节点。")},i="ontouchstart"in window,a=i?"touchstart":"mousedown",o=i?"touchmove":"mousemove",r=i?"touchend":"mouseup",n=i?"touchcancel":"mouseleave";return s.prototype.setCallback=function(e){return this._configs.callback=e,this},s.prototype.detectViewport=function(){var t=this._configs,s=this.maskedDom,i=document.documentElement.clientHeight,a=t.width?t.width:s.offsetWidth-s.clientLeft-window.parseInt(getComputedStyle(s).borderRightWidth),o=t.height?t.height:s.offsetHeight-s.clientTop-window.parseInt(getComputedStyle(s).borderBottomWidth);this.maskWidth=a-t.left,this.maskHeight=o-t.top,this.calculHeight=this.maskedDom===document.body?i:o,this.transformStr=e.setCssPrefix("transform")},s.prototype.generateMask=function(){this.maskCanvas=document.createElement("canvas");var e="background-color: transparent;";e+="position: absolute;",e+="z-index: 3;",e+="left: "+this._configs.left+"px;",e+="top: "+this._configs.top+"px;",this.maskCanvas.style.cssText+=e;var t=getComputedStyle(this.maskedDom);"absolute"!==t.position&&"relative"!==t.position&&(this.maskedDom.style.position="relative"),this.originOverflow=t.overflow||"",this.maskedDom.style.overflow="hidden",this._configs.alpha&&this.setOpacity(this._configs.alpha),this.maskedDom.appendChild(this.maskCanvas)},s.prototype.setOpacity=function(e){return this.maskCanvas.style.opacity=e/100,this._configs.alpha=e,this},s.prototype.configMask=function(t){var s=this._configs;if(this.detectViewport(),s.eraseImage&&this.createEraseImage(),s.eraseCoverImage&&this.createEraseCoverImage(),s.eraseCoverText&&(this.airIndexTip=this.buildAirIndexTip(this.maskWidth/2,this.calculHeight/2,s.eraseCoverImageWidth,s.eraseCoverImageHeight),this.buildAirIndexText(s.eraseCoverText,s.eraseCoverTextDesc)),s.logoImage)this.handleLogo();else if(s.logoDom){this.logoImage=e.getElement(s.logoDom);var i=e.getOffset(this.logoImage);this._logoLeft=i[0],this._logoTop=i[1]}s.closeImg&&this.createCloseImage(),s.backgroundImage&&this.createBackgroundImage(),this.setMaskSize(t)},s.prototype.setMaskSize=function(e){var t=this,s=this.maskedDom,i=this._configs;this.maskCanvas.width=this.maskWidth,this.maskCanvas.height=this.maskHeight;var a=s.getBoundingClientRect();this._offsetX=a.left+document.body.scrollLeft+s.clientLeft,this._offsetY=a.top+document.body.scrollTop+s.clientTop;var o=this.maskCanvas.getContext("2d");if(i.maskImage){var t=this,r=document.createElement("img");r.src=i.maskImage,r.style.display="none",document.body&&document.body.appendChild(r),r.addEventListener("load",function(){o.drawImage(r,0,0,t.maskWidth,t.maskHeight),o.globalCompositeOperation="destination-out",document.body&&document.body.removeChild(r),r=null,t.generateCheckPoints();try{o.getImageData(0,0,1,1)}catch(s){t.isTainted=!0}e&&e()},!1)}else o.fillStyle=i.color,o.fillRect(0,0,this.maskWidth,this.maskHeight),this.generateCheckPoints(),o.globalCompositeOperation="destination-out",e&&e()},s.prototype.createEraseImage=function(){var e=this._configs,t=-e.angle;this.eraseImage=this.createFloatImage(e.eraseImage,this.maskWidth/2,this.calculHeight/2,e.eraseImageWidth,e.eraseImageHeight),t&&!e.eraseCoverImage&&(this.eraseImage.style[this.transformStr]="rotate("+t+"deg)")},s.prototype.createCloseImage=function(){var e=this._configs,t=this._logoTop+this.logoImage.offsetHeight/2-5;this.closeImage=this.createFloatImage(e.closeImg,this.maskWidth-29,t,27,27),this.closeImage.addEventListener("click",function(){e.onClose&&e.onClose()},!1)},s.prototype.createBackgroundImage=function(){var t=this._configs,s=this.maskWidth,i=this.calculHeight;this.backgroundImage=this.createFloatDom("div",s/2,i-t.backgroundImageHeight/2,s,t.backgroundImageHeight/t.backgroundImageWidth*s,function(s){if(e.isString(t.backgroundImage)){var i="background-image: url("+t.backgroundImage+");background-repeat: no-repeat;";i+="background-size: 100% 100%;",s.style.cssText+=i}},2)},s.prototype.createEraseCoverImage=function(){var e=this._configs,t=-e.angle;this._isEraseCovered=!0;var s=this.maskWidth,i=this.calculHeight;this.eraseCoverImage=this.createFloatImage(e.eraseCoverImage,s/2,i/2,e.eraseCoverImageWidth,e.eraseCoverImageHeight),this.eraseCoverImage.style.zIndex=5;var n=this;this.eraseCoverImage.addEventListener(a,function(e){n.maskedDom.removeChild(n.eraseCoverImage),n.maskedDom.removeChild(n.eraseCoverImageBg),n.eraseCoverImage=null,n.eraseCoverImageBg=null,n.airIndexTip&&(n.maskedDom.removeChild(n.airIndexTip),n.airIndexTip=null),n.eraseImage.style[n.transformStr]="rotate("+t+"deg)",n._isEraseCovered=!1,n.startErase(e)},!1),this.eraseCoverImage.addEventListener(o,this,!1),this.eraseCoverImage.addEventListener(r,this,!1),this.eraseCoverImageBg=this.createFloatDom("div",s/2,i/2,80,80,function(e){n.createAnim(e,s/2,i/2);var t="z-index: 3;background-color: #20b9e4; opacity: 0.4;border-radius:50px;";e.style.cssText+=t}),this.eraseCoverImage.style.zIndex=5},s.prototype.createAnim=function(e,t,s){this.preStyleDom&&document.head.removeChild(this.preStyleDom);var i=document.createElement("style"),a="width:80px;height:80px;left:"+(t-40)+"px;top:"+(s-40)+"px;opacity: 0.4;border-radius:40px;",o="width:80px;height:80px;left:"+(t-40)+"px;top:"+(s-40)+"px;opacity: 0;border-radius:40px;",r="width:150px;height:150px;left:"+(t-75)+"px; top:"+(s-75)+"px;opacity: 0;border-radius:75px;";this.preStyleDom=i,this.preStyleIdx=this.preStyleIdx?this.preStyleIdx+1:1,i.innerHTML="@-webkit-keyframes sensorCoverBigger"+this.preStyleIdx+" {0%{"+a+"}90%{"+r+"}95%{"+o+"}100%{"+a+"}}@-moz-keyframes sensorCoverBigger {0%{"+a+"}90%{"+r+"}95%{"+o+"}100%{"+a+"}}@keyframes sensorCoverBigger {0%{"+a+"}90%{"+r+"}95%{"+o+"}100%{"+a+"}}";var n="-webkit-animation:sensorCoverBigger"+this.preStyleIdx+" 2s 1s forwards linear infinite;";n+="-moz-animation:sensorCoverBigger"+this.preStyleIdx+" 2s 1s forwards linear infinite;",n+="animation:sensorCoverBigger"+this.preStyleIdx+" 2s 1s forwards linear infinite;",e.style.cssText+=n,document.head.appendChild(i)},s.prototype.handleLogo=function(){var t=this._configs;if(e.isString(t.logoImage)){this.logoImage=t.logoDom?e.getElement(t.logoDom):document.createElement("div");var s="background-image: url("+t.logoImage+");background-repeat: no-repeat;";if(s+="background-position: 4px 3px;",s+="background-size: "+t.logoWidth+"px "+t.logoHeight+"px;",this.logoImage.style.cssText+=s,t.logoLink){var i=getComputedStyle(this.logoImage);"absolute"!==i.position&&"relative"!==i.position&&(this.logoImage.style.position="relative");var o=document.createElement("a");o.href=t.logoLink,o.style.cssText="position:absolute;width:100%;height:100%;",this.logoImage.appendChild(o)}t.logoDom||this.maskedDom.appendChild(this.logoImage)}else this.logoImage=t.logoImage;var r=e.getOffset(this.logoImage);this._logoLeft=r[0],this._logoTop=r[1];var n=this;this.logoImage.addEventListener(a,function(){n._configs.logoClickStart&&n.start(),n.onLogoClick&&n.onLogoClick()},!1)},s.prototype.refreshMaskSize=function(){var t=this._configs;this.detectViewport(),this.setMaskSize();var s=this.maskWidth,i=this.calculHeight;if(this.eraseImage&&(this.eraseImage.style.left=(s-t.eraseImageWidth)/2+"px",this.eraseImage.style.top=(i-t.eraseImageHeight)/2+"px"),this.eraseCoverImage&&(this.eraseCoverImage.style.left=(s-t.eraseCoverImageWidth)/2+"px",this.eraseCoverImage.style.top=(i-t.eraseCoverImageHeight)/2+"px"),this.eraseCoverImageBg&&(this.eraseCoverImageBg.style.left=s/2-40+"px",this.eraseCoverImageBg.style.top=i/2-40+"px",this.createAnim(this.eraseCoverImageBg,s/2,i/2)),this.airIndexTip&&(this.airIndexTip.style.left=(s-t.eraseCoverImageWidth)/2+"px",this.airIndexTip.style.top=(i+t.eraseCoverImageHeight)/2-20+"px"),this.logoImage||this.logoDom){var a=e.getOffset(this.logoImage);this._logoLeft=a[0],this._logoTop=a[1]}if(this.closeImage){var o=this.maskWidth-42.5,r=this._logoTop+this.logoImage.offsetHeight/2-18.5;this.closeImage.style.left=o+"px",this.closeImage.style.top=r+"px"}return this.backgroundImage&&(this.backgroundImage.style.left=s/2,this.backgroundImage.style.top=i-t.backgroundImageHeight/2,this.backgroundImage.style.width=s+"px",this.backgroundImage.style.height=t.backgroundImageHeight/t.backgroundImageWidth*s+"px"),this},s.prototype.start=function(){function e(e){t._configs.showPoint&&t.getErasePercent(!0),t.eraseImage&&(t.eraseImage.addEventListener(a,t,!1),t.eraseImage.addEventListener(o,t,!1),t.eraseImage.addEventListener(r,t,!1))}var t=this;if(t.maskedDom)return t.maskCanvas||t.generateMask(),this.maskCanvas.addEventListener(a,function(e){e.preventDefault()},!1),this.maskCanvas.addEventListener(o,function(e){e.preventDefault()},!1),this.maskCanvas.addEventListener(a,this,!1),this.maskCanvas.addEventListener(o,this,!1),this.maskCanvas.addEventListener(r,this,!1),this.maskCanvas.addEventListener(n,this,!1),t.configMask(e),this},s.prototype.clearMask=function(s,i){function h(){f.clearRainDrop(),d.clearRect(0,0,f.maskCanvas.width,f.maskCanvas.height),f.eraseCoverImage&&(f.maskedDom.removeChild(f.eraseCoverImage),f.maskedDom.removeChild(f.eraseCoverImageBg),f.eraseCoverImage=null,f.eraseCoverImageBg=null),f.airIndexTip&&(f.maskedDom.removeChild(f.airIndexTip),f.airIndexTip=null),f.closeImage&&(f.maskedDom.removeChild(f.closeImage),f.closeImage=null),f.backgroundImage&&(f.maskedDom.removeChild(f.backgroundImage),f.backgroundImage=null),i&&i()}function g(){if(f.maskCanvas){var t=(Date.now()-m)/s;return t>1?void h():(l=(1-c(t))*p,f.maskCanvas.style.opacity=l,f.setRainDropOpacity(l),e.nextFrame(g),void 0)}}this.maskCanvas.removeEventListener(a,this,!1),this.maskCanvas.removeEventListener(o,this,!1),this.maskCanvas.removeEventListener(r,this,!1),this.maskCanvas.removeEventListener(n,this,!1),this.eraseImage&&(this.eraseImage.removeEventListener(a,this,!1),this.eraseImage.removeEventListener(o,this,!1),this.eraseImage.removeEventListener(r,this,!1));var l,d=this.maskCanvas.getContext("2d"),m=Date.now(),c=t("ease-out"),p=this._configs.alpha/100||1,f=this;return s?g():h(),this},s.prototype.stop=function(){return this.maskedDom?(this.maskedDom.removeChild(this.maskCanvas),this.maskCanvas=null,this.maskedDom.style.overflow=this.maskedDom.originOverflow,this):void 0},s.prototype.handleEvent=function(e){if(!this._isEraseCovered)switch(e.type){case a:return this.startErase(e);case o:return this.doErase(e);case r:return this.endErase(e);case n:return this.endErase(e)}},s.prototype.startErase=function(e){e.preventDefault(),this._startedErase=!0,this.eraseRecords=[]},s.prototype.doErase=function(e){if(e.preventDefault(),this._startedErase){e.changedTouches&&(e=e.changedTouches[e.changedTouches.length-1]);var t=(e.clientX+document.body.scrollLeft||e.pageX)-this._offsetX||0,s=(e.clientY+document.body.scrollTop||e.pageY)-this._offsetY||0;this._configs.onStart&&!this._firedOnStart&&(this._configs.onStart(t,s),this._firedOnStart=!0),this.eraseImage&&(this.eraseImage.style.left=t-this.eraseImage.offsetWidth/2+"px",this.eraseImage.style.top=s-this.eraseImage.offsetHeight/2+"px");var i=this._configs.radius,a=this.maskCanvas.getContext("2d");a.beginPath(),this._configs.eraseWidth&&!this._configs.useRadius?(a.fillStyle="#000",this._configs.smooth?this.eraseOval(a,t-this._configs.left,s-this._configs.top,this._configs.eraseWidth,this._configs.eraseHeight,-this._configs.angle,this._configs.alphaRadius):this.eraseRect(a,t,s,this._configs.eraseWidth,this._configs.eraseHeight,this._configs.angle),a.fillStyle="#000"):(this.eraseCircle(a,t-this._configs.left,s-this._configs.top,i,this._configs.alphaRadius),a.fillStyle="#000"),this.isTainted&&this.eraseRecords.push([t,s]),this._prevX=t,this._prevY=s}else this._prevX=0,this._prevY=0},s.prototype.eraseCircle=function(e,t,s,i,a){if(e.beginPath(),a){var o=i+a,r=e.createRadialGradient(t,s,i,t,s,o);r.addColorStop(0,"rgba(255, 255, 255, 1)"),r.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=r,e.arc(t,s,o,0,2*Math.PI)}else e.arc(t,s,i,0,2*Math.PI);e.fill()},s.prototype.eraseRect=function(e,t,s,i,a,o){o?(e.save(),e.translate(t,s),e.rotate(o*Math.PI/180),e.fillRect(-i/2,-a/2,i,a),e.restore()):e.fillRect(t-i/2,s-a/2,i,a)},s.prototype.eraseOval=function(e,t,s,i,a,o,r){function n(t,s,i,a){var o=i/.6/2,n=a/2;if(r&&(n+=r),e.beginPath(),e.moveTo(t,s-n),e.bezierCurveTo(t+o,s-n,t+o,s+n,t,s+n),e.bezierCurveTo(t-o,s+n,t-o,s-n,t,s-n),r){var h=0,g=a+r,l=e.createRadialGradient(t,s,h,t,s,g);l.addColorStop(0,"rgba(255, 255, 255, 1)"),l.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=l}e.fill(),e.closePath()}o?(e.save(),e.translate(t,s),e.rotate(o*Math.PI/180),n(0,0,i,a),e.restore()):n(t,s,i,a)},s.prototype.endErase=function(e){if(this._startedErase){e.preventDefault(),this._startedErase=!1;var t=this.getErasePercent();this._configs.callback&&this._configs.callback(100*t,this._prevX,this._prevY)}},s.prototype.generateCheckPoints=function(){this.checkPoints=[];for(var e,t,s=this.maskCanvas.width-this._configs.left,i=this.calculHeight-this._configs.top,a=this._configs.checkDistance,o=Math.ceil(s/a),r=Math.ceil(i/a),n=0;o>n;n++)for(var h=0;r>h;h++)e=n===o-1?s/2+(o-1)*a/2:window.parseInt(a/2+n*a),t=h===r-1?i/2+(r-1)*a/2:window.parseInt(a/2+h*a),this.checkPoints.push([e,t,0])},s.prototype.getErasePercent=function(e){var t,s=this.maskCanvas.width,i=this.maskCanvas.height,a=this.maskCanvas.getContext("2d");if(this.isTainted||(t=a.getImageData(0,0,s,i)),this.isTainted&&!e)return this.getErasePercentByRecord();var o,r,n,h=0;e&&(a.globalCompositeOperation="source-over",a.fillStyle="#000");for(var g=this.checkPoints,l=g.length,d=0;l>d;d++)o=g[d][0],r=g[d][1],this.isTainted||(n=this.getColorValue(t,o,r),0===n[3]&&h++),e&&a.fillRect(o,r,1,1);return e?void(a.globalCompositeOperation="destination-out"):h/l},s.prototype.getErasePercentByRecord=function(){for(var e,t=this.eraseRecords,s=this.checkPoints,i=s.length,a=0,o=0,r=0,n=t.length;n>r;r++){e=this.getNeedCheckArr(t[r]);for(var h=0;i>h;h++)a++,s[h][2]||(o++,this._configs.radius>=this.calculateDis(t[r],s[h])&&(s[h][2]=1))}for(var g=0,l=0;i>l;l++)s[l][2]&&g++;return g/i},s.prototype.getNeedCheckArr=function(e){},s.prototype.calculateDis=function(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))},s.prototype.getColorValue=function(e,t,s){var i=4*(t+s*e.width),a=e.data[i],o=e.data[i+1],r=e.data[i+2],n=e.data[i+3];return[a,o,r,n]},s.prototype.rainDrop=function(s,i,a,o,r,n,h){function g(){if(d.maskCanvas){var t=(Date.now()-c)/n;return t>1?(d.eraseRect(m,i,a+h/2,o,h),void d.eraseCircle(m,i,a+h,o/2)):(v=f(t)*h,d.eraseRect(m,i,a+f(t)*h/2,o,v),p.style.top=a+l.top+v-3+"px",e.nextFrame(g),void 0)}}if(this.maskCanvas){var l=this._configs;i-=l.left||0,a-=l.top||0;var d=this,m=this.maskCanvas.getContext("2d"),c=Date.now(),p=d.createFloatImage(s,i+1,a-3,o+6,r+6),f=t("ease-out");this.rainDrops=this.rainDrops||[],this.rainDrops.push(p);var v;return this.eraseCircle(m,i,a,o/2),g(),this}},s.prototype.clearRainDrop=function(){if(this.rainDrops&&this.maskedDom){for(var e=0,t=this.rainDrops.length;t>e;e++)this.maskedDom.removeChild(this.rainDrops[e]);return this.rainDrops=[],this}},s.prototype.setRainDropOpacity=function(e){if(this.rainDrops&&this.maskedDom){for(var t=0,s=this.rainDrops.length;s>t;t++)this.rainDrops[t].style.opacity=e;return this}},s.prototype.createFloatDom=function(t,s,i,a,o,r,n){var h,g;t||(t="div"),h=e.isString(t)?document.createElement(t):t;var g="position: absolute;";return g+="z-index: "+(n||4)+";",g+="left: "+(s-a/2)+"px;",g+="top: "+(i-o/2)+"px;",g+="width: "+a+"px;",g+="height: "+o+"px;",h.style.cssText+=g,e.isFunction(r)&&r(h),this.maskedDom.appendChild(h),h},s.prototype.createFloatImage=function(t,s,i,a,o){var r,n,h="div";return e.isString(t)||(h=t),r=this.createFloatDom(h,s,i,a,o,function(s){e.isString(t)&&(n="background-image: url("+t+");background-repeat: no-repeat;",n+="background-size: 100% 100%;",s.style.cssText+=n)},3)},s.prototype.rotateEraseImage=function(s,i){function a(){if(v.maskCanvas){var t=(Date.now()-r)/s;return t>1?(v.maskedDom.removeChild(v.eraseImage),v.eraseImage=null,void i()):(p=p>=360?0:p+20,o="left:"+(g+(d-g)*f(t))+"px;top:"+(l+(m-l)*f(t))+"px;width:"+n*(1-f(t))+"px;height:"+h*(1-f(t))+"px",v.eraseImage.style.cssText+=o,v.eraseImage.style[v.transformStr]="rotate("+p+"deg)",e.nextFrame(a),void 0)}}var o,r=Date.now(),n=this.eraseImage.offsetWidth,h=this.eraseImage.offsetHeight,g=window.parseInt(this.eraseImage.style.left),l=window.parseInt(this.eraseImage.style.top),d=this._logoLeft+this.logoImage.offsetWidth/2,m=this._logoTop+this.logoImage.offsetHeight/2,c=-this._configs.angle,p=c,f=t("ease-out"),v=this;s?a():(this.maskedDom.removeChild(this.eraseImage),this.eraseImage=null,i())},s.prototype.buildAirIndexTip=function(e,t,s,i){var a=this.createFloatDom("div",e,t+i/2+10,s,50,function(e){var t="font-size: 17px; color: #fff; text-align: center;";t+="text-shadow: 1px 1px 1px #040000;",t+="-webkit-text-shadow: 1px 1px 1px #040000;",t+="-moz-text-shadow: 1px 1px 1px #040000;",t+="line-height: 21px;",e.style.cssText+=t},4);return a},s.prototype.buildAirIndexText=function(e,t){return this.airIndexTip.innerHTML='<h3 style="padding: 0; margin: 0; line-height: 20px; font-size: 17px;">空气质量指数</h3><p style="margin:0;padding:5px 0;font-size: 24px;">'+e+'<i style="display: inline-block; min-width: 50px; line-height: 16px;height: 16px;color: #fff; background-color: #0996d1;text-shadow: none;-webkit-text-shadow: none;-moz-text-shadow: none;-webkit-border-radius: 16px;-moz-border-radius: 16px;border-radius: 16px;margin-left:5px;font-style: normal;font-size: 13px;font-weight: normal;vertical-align: top;margin-top: 2px;padding: 0 5px;">'+t+"</i></p>",this},s});